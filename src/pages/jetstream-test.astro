---
import Layout from '../layouts/Layout.astro';
import { loadConfig } from '../lib/config/site';

const config = loadConfig();
---

<Layout title="Jetstream Test">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-8">Jetstream Repository Test</h1>
    
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
      <h2 class="text-2xl font-semibold mb-4">Configuration</h2>
      <p><strong>Handle:</strong> {config.atproto.handle}</p>
      <p><strong>DID:</strong> {config.atproto.did}</p>
      <p class="text-sm text-gray-600 mt-2">This uses ATProto sync API to stream all repository activity with DID filtering, similar to atptools.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h2 class="text-2xl font-semibold mb-4">Connection</h2>
        <button id="start-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Start Jetstream
        </button>
        <button id="stop-btn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 ml-2" disabled>
          Stop Stream
        </button>
        <div id="status" class="mt-4 p-2 rounded bg-gray-100">
          Status: <span id="status-text">Stopped</span>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h2 class="text-2xl font-semibold mb-4">Statistics</h2>
        <div class="space-y-2">
          <div>Records received: <span id="records-count" class="font-bold">0</span></div>
          <div>Streaming status: <span id="streaming-status" class="font-bold">Stopped</span></div>
          <div>Last sync: <span id="last-sync" class="font-bold">Never</span></div>
        </div>
      </div>
    </div>

    <div class="mt-8">
      <h2 class="text-2xl font-semibold mb-4">Live Records</h2>
      <div id="records-container" class="space-y-4 max-h-96 overflow-y-auto">
        <p class="text-gray-500 text-center py-8">No records received yet...</p>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { JetstreamClient } from '../lib/atproto/jetstream-client';

  let client: JetstreamClient | null = null;
  let recordsCount = 0;

  // DOM elements
  const startBtn = document.getElementById('start-btn') as HTMLButtonElement;
  const stopBtn = document.getElementById('stop-btn') as HTMLButtonElement;
  const statusText = document.getElementById('status-text') as HTMLSpanElement;
  const recordsCountEl = document.getElementById('records-count') as HTMLSpanElement;
  const streamingStatusEl = document.getElementById('streaming-status') as HTMLSpanElement;
  const lastSyncEl = document.getElementById('last-sync') as HTMLSpanElement;
  const recordsContainer = document.getElementById('records-container') as HTMLDivElement;

  function updateStatus(status: string) {
    statusText.textContent = status;
    streamingStatusEl.textContent = status;
    
    if (status === 'Streaming') {
      startBtn.disabled = true;
      stopBtn.disabled = false;
    } else {
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  }

  function updateLastSync() {
    lastSyncEl.textContent = new Date().toLocaleTimeString();
  }

  function addRecord(record: any) {
    recordsCount++;
    recordsCountEl.textContent = recordsCount.toString();

    const recordEl = document.createElement('div');
    recordEl.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4';
    
    const time = new Date(record.time_us / 1000).toLocaleString();
    const collection = record.collection;
    const $type = record.$type;
    const service = record.service;
    const text = record.value?.text || 'No text content';
    
    recordEl.innerHTML = `
      <div class="flex items-start space-x-3">
        <div class="flex-1 min-w-0">
          <div class="flex items-center space-x-2 mb-2">
            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">${service}</span>
            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">${collection}</span>
            <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-medium">${$type}</span>
            <span class="bg-${record.operation === 'create' ? 'green' : record.operation === 'update' ? 'yellow' : 'red'}-100 text-${record.operation === 'create' ? 'green' : record.operation === 'update' ? 'yellow' : 'red'}-800 px-2 py-1 rounded text-xs font-medium">${record.operation}</span>
          </div>
          ${text ? `<p class="text-sm text-gray-600 mb-2">${text}</p>` : ''}
          <p class="text-xs text-gray-500">${time}</p>
          <p class="text-xs font-mono text-gray-400 mt-1 break-all">${record.uri}</p>
        </div>
      </div>
    `;

    recordsContainer.insertBefore(recordEl, recordsContainer.firstChild);
    
    // Keep only the last 20 records
    const records = recordsContainer.querySelectorAll('div');
    if (records.length > 20) {
      records[records.length - 1].remove();
    }
  }

  startBtn.addEventListener('click', async () => {
    try {
      updateStatus('Starting...');
      
      client = new JetstreamClient();
      
      client.onConnect(() => {
        updateStatus('Streaming');
        console.log('Jetstream connected');
      });

      client.onDisconnect(() => {
        updateStatus('Stopped');
        console.log('Jetstream disconnected');
      });

      client.onError((error) => {
        console.error('Jetstream error:', error);
        updateStatus('Error');
      });

      client.onRecord((record) => {
        console.log('Record received:', record);
        addRecord(record);
        updateLastSync();
      });

      await client.startStreaming();
      
    } catch (error) {
      console.error('Failed to start jetstream:', error);
      updateStatus('Error');
      alert('Failed to start jetstream. Check the console for details.');
    }
  });

  stopBtn.addEventListener('click', () => {
    if (client) {
      client.stopStreaming();
      client = null;
    }
  });
</script> 